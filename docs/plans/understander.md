# Агенты: роли и ответственности

## Портрет пользователя (гипотеза)

**Кто он:**
- Ритейл дейтрейдер NQ/ES фьючерсов
- Торгует внутри дня или скальпит
- Счёт небольшой — часто микро-контракты (MNQ/MES)
- Пришёл во фьючерсы чтобы обойти PDT rule
- Самоучка — учится 1-3 года, много проб и ошибок

**Его боли:**
- Торгует по ощущениям, не по данным
- Не знает работают ли его сетапы статистически
- Не понимает как ведёт себя рынок в разных условиях
- Принимает решения без исторического контекста

**Когда он приходит:**
- **ДО торговли** — подготовка и исследование
- Вечером или на выходных — анализ идей
- Не во время торговли — у нас нет realtime

**Что ему нужно:**
- Проверить идею на исторических данных
- Понять паттерны поведения рынка
- Узнать как рынок вёл себя в похожих условиях
- Подготовиться к определённым дням (OPEX, NFP, FOMC)

**Как он говорит:**
- Не в терминах SQL — в терминах трейдинга
- "Работает ли торговля после gap up?"
- "Пятницы лучше понедельников?"
- "Как ведёт себя рынок в дни OPEX?"
- "Какой был типичный range в 2024?"

**Чего он НЕ может (нет realtime):**
- "Сегодня волатильность выше обычного?" — нет данных за сегодня
- "Это нормальное движение?" — про текущее
- "Что будет дальше?" — предсказания

**Подтверждение портрета (Reddit/форумы):**

Исследование трейдерских комьюнити (r/Daytrading 3.9M, r/FuturesTrading 93K) подтверждает:

| Тема | Что спрашивают |
|------|----------------|
| **Время** | "когда лучше торговать?", "RTH или overnight?" |
| **Инструмент** | "ES или NQ?", "micro или mini?" |
| **Капитал** | "сколько нужно начать?", "PDT rule обход" |
| **Стратегии** | "работает ли breakout?", "как торговать VWAP?" |
| **Риск** | "какой стоп?", "как не слить?" |
| **События** | "как торговать FOMC?", "NFP опасен?" |

Типичный профиль подтверждён:
- Новички с небольшим капиталом → micro contracts (MNQ/MES)
- Пришли из-за PDT rule ($25K minimum для stocks)
- Хотят понять когда/как/что торговать
- Боятся слить из-за leverage

**Валидация продукта:**

Исследование показало — трейдеры уже используют AI (ChatGPT) как:

| Использование | Что делают |
|---------------|------------|
| **Thinking partner** | Обсуждение идей, структурирование мыслей |
| **Код** | Генерация Pine Script, Python для бэктестов |
| **Sentiment** | Анализ новостей, Reddit, Twitter |
| **Журнал** | Организация trading journal |

Чего **НЕ** ждут от AI:
- "Скажи что покупать" → не работает, теряют деньги
- Realtime данные → ChatGPT не знает текущие цены

**Почему наш продукт имеет смысл:**

| Проблема рынка | Наше решение |
|----------------|--------------|
| ChatGPT не знает цены | У нас исторические данные NQ |
| Нет проверки сетапов | "Работает ли паттерн?" на реальных данных |
| Общие советы | Конкретная статистика по запросу |
| Сигналы "купи/продай" не работают | Мы даём анализ, решение за трейдером |

**Наша ниша:** AI thinking partner с доступом к реальным данным.

---

## Проблема

Parser получает сырой вопрос → гадает → ошибается.

```
User: "статистика" → Parser угадал → неправильный результат
```

## Решение

Разделить понимание и парсинг. Три агента:

```
User → Understander → Clarifier → Parser → Executor
           ↓              ↓           ↓
       понимает      уточняет    конвертит
```

---

## Understander

**Роль:** Понять что хочет пользователь.

**Принцип:** Лучше спросить, чем угадать.

> Умность системы — не в способности угадывать, а в способности задавать правильные вопросы.

---

### Алгоритм работы

```
ВХОД: сырой вопрос пользователя

ШАГ 1: INTENT
   └→ data / chitchat / concept
   └→ если не data → передать другому агенту, выход

ШАГ 2: GOAL (первичен!)
   ├→ явный: "чтобы понять где ставить стоп"
   ├→ выводимый: из типа запроса
   └→ неясный: → Clarifier уточняет

ШАГ 3: ПРОВЕРКА ПОНЯТНОСТИ
   ├→ все термины известны? (проверка по config)
   ├→ операция понятна? (list/count/compare/...)
   ├→ параметры полны? (или есть defaults)
   └→ если что-то неясно → Clarifier уточняет

ШАГ 4: EXPANSION
   └→ расширить запрос с учётом goal
   └→ заполнить defaults
   └→ перевести на язык системы

ВЫХОД: goal + expanded_query → Parser
```

**Приоритет: Goal → Expansion**

```
Вопрос → Goal (ЗАЧЕМ?) → Expanded Query (учитывает goal)
```

Одинаковый вопрос + разные цели = разные запросы:
- "range дня" + цель "стопы" → distribution + p5/p95
- "range дня" + цель "волатильность" → distribution + сравнение

---

### Вход / Выход

**Вход:**
```
{
  "user_query": "Какой типичный range дня?",
  "context": { ... }  # история разговора, если есть
}
```

**Выход:**
```
{
  "intent": "data",
  "goal": "sizing стопов",
  "understood": true,
  "expanded_query": "Показать распределение дневного range RTH: mean, median, p5, p95",
  "need_clarification": null
}
```

Или если нужно уточнить:
```
{
  "intent": "data",
  "goal": null,
  "understood": false,
  "expanded_query": null,
  "need_clarification": {
    "reason": "цель неясна",
    "question": "Это чтобы понять где ставить стоп? Или оценить волатильность?"
  }
}
```

**Куда идёт выход:**
- `expanded_query` → Parser (конвертит в atoms)
- `goal` → Presenter (контекст для ответа)

---

### Знания Understander'а

**1. Домен (из `agent/config/`):**

| Конфиг | Что знает |
|--------|-----------|
| `market/instruments.py` | Сессии (ETH, RTH, Overnight), торговые часы |
| `market/holidays.py` | Праздники, early close |
| `market/events.py` | OPEX, NFP, FOMC — что это и когда |
| `patterns/candle.py` | doji, hammer, engulfing... |
| `patterns/price.py` | inside_bar, NR7, higher_high... |

Примеры проверок:
- "день" → instruments → ETH или RTH? → уточнить
- "doji" → patterns → есть → ок
- "фрактал" → patterns → нет → уточнить

**2. Инструментарий (как система считает):**

| Знание | Зачем |
|--------|-------|
| Операции | list, count, compare, distribution, around, streak... |
| Timeframes | 1H = часовые бары, 1D = дневные бары |
| Фильтры | session=RTH фильтрует, но не агрегирует |
| Метрики | change, range, volume, gap... |

Пример важности:
```
"range дня" может значить:
1. range каждого бара → mean 18 пунктов
2. range всей сессии → ~180 пунктов

Understander должен понять что пользователь хочет #2
```

**3. Перевод (человеческий → системный):**

| Человек говорит | Система понимает |
|-----------------|------------------|
| "типичный", "средний", "обычно" | → distribution |
| "сколько раз" | → count |
| "когда было" | → list |
| "лучше или хуже" | → compare |
| "что после" | → around |
| "работает ли" | → probability или compare |

**4. Границы системы:**

Understander знает что система НЕ может:
- Realtime данные ("сегодня", "сейчас")
- Предсказания ("что будет")
- Данные которых нет (VIX, уровни, индикаторы)

---

### Когда уточнять, когда нет

**Уточнять:**
- Goal неясен И влияет на результат
- Термин неизвестен (нет в config)
- Операция неоднозначна ("статистика" = ?)
- Порог не указан ("большой gap" = ?)

**НЕ уточнять (defaults):**
- Период не указан → all
- Метрика не указана → change
- Лимит не указан → 10
- Сортировка не указана → desc
- Goal очевиден из запроса

**Правило:** 1-2 уточнения максимум, не допрос.

---

## Clarifier

**Роль:** Управлять диалогом уточнения.

**Ответственность:**
- Задать понятный вопрос на языке пользователя
- Предложить примеры/варианты
- Передать ответ обратно в Understander
- Обработать edge cases (нет ответа, непонятный ответ, смена темы)

**Принцип:** Один вопрос за раз. Конкретно, с примерами.

---

### Приоритизация уточнений

Если несколько неточностей — не спрашивать всё. Приоритет:

```
1. ЦЕЛЬ — всегда первая (из неё выводится многое)
2. Операция — если неясна
3. Детали — только если не выводятся из цели
```

**Пример:**
```
"какой range дня?"

Неточности: цель + что такое "день"
         ↓
Clarifier: приоритет = цель
         ↓
"Это для sizing стопов?"
         ↓
User: "да"
         ↓
Understander: цель = стопы → значит RTH (когда торгует)
         ↓
→ не спрашиваем про "день", выводим из цели
```

**Логика:**
- Сначала уточнить самое важное
- Из ответа попробовать вывести остальное
- Спрашивать только то, что не выводится

---

### Edge cases

**Пользователь не отвечает:**
- Clarifier напоминает / переформулирует вопрос
- После N попыток → предложить продолжить с тем что поняли

**Ответ непонятен:**
- Clarifier переспрашивает конкретнее
- Предлагает варианты выбора

**Максимум итераций (2-3):**
- После нескольких уточнений → fallback:
  - "Сформулируй точнее"
  - ИЛИ "Вот что я понял: X. Продолжить с этим?"

**Смена темы в середине:**
```
User: "какой range дня?"
Clarifier: "Для стопов или оценить волатильность?"
User: "а какие паттерны бывают?"  ← смена темы
         ↓
Clarifier: это не ответ, это новый запрос
         ↓
→ передать на Understander как новый вход
```

---

## Parser

**Роль:** Конвертировать ясную задачу в структуру.

**Ответственность:**
- Получить понятное описание задачи
- Разложить в atoms (when, what, filter, timeframe)
- Определить операцию

**Принцип:** Не гадает. Получает ясное ТЗ — конвертит.

---

## Типы неоднозначностей

### Группа 1: Слово → Значение
*Пользователь сказал слово, но оно неоднозначно*

**Временные:**
- "день" → ETH (торговый день)? RTH (сессия)? календарный?
- "недавно" → неделя? месяц?
- "утром" → pre-market? первый час RTH?
- "вчера" → последний торговый день? календарное вчера?

**Метрики:**
- "волатильность" → range? ATR? std dev?
- "движение" → change? range?
- "объём" → контракты? относительный?

**Пороги:**
- "большой gap" → 0.5%? 1%? 2%?
- "сильный тренд" → сколько дней? какой %?
- "часто" → какая частота?

**Количество:**
- "несколько" → 3? 5? 10?
- "много" → больше чем обычно?

→ Суть: **слово нужно уточнить до конкретного значения**

---

### Группа 2: Запрос → Действие
*Непонятно какое действие выполнить*

**Общие слова:**
- "покажи" → список? статистику? распределение?
- "статистика" → среднее? распределение? сравнение?
- "анализ" → что именно проанализировать?

**Неполные операции:**
- "сравни понедельники и пятницы" → по какой метрике?
- "после gap up" → что показать после?
- "вероятность" → вероятность чего?

**Составные:**
- "покажи и сравни" → одна операция или две?
- "doji и что после" → список + around?

→ Суть: **действие нужно уточнить до конкретной операции**

---

### Группа 3: Контекст → Понимание
*Нужен контекст чтобы понять*

**Инструмент:**
- Сессии NQ (ETH/RTH/Overnight) ≠ сессии акций (только RTH)
- Gap есть только для daily
- Разные торговые часы

**Референс:**
- "как обычно" → по сравнению с чем?
- "похожие дни" → похожие по какому критерию?
- "выше среднего" → среднее за какой период?

**История разговора:**
- "тот паттерн" → который обсуждали раньше
- "покажи ещё" → ещё чего?

→ Суть: **нужен контекст (инструмент, разговор, сравнение)**

---

## Defaults (когда НЕ уточнять)

- Период не указан → all
- Метрика не указана → change
- Лимит не указан → 10
- Сортировка не указана → desc

---

## Примеры диалогов

### 1. Слишком общий запрос

```
User: покажи статистику

Understander: ❌ не понял
  → "статистика" слишком общее
  → нужно: что считать, за какой период

Clarifier: Какую статистику показать?
           Например: волатильность, доходность, объём?

User: волатильность

Understander: ❌ ещё не всё
  → нужно: период

Clarifier: За какой период?

User: 2024

Understander: ✓ понял
  → "покажи распределение волатильности за 2024"
```

### 2. Сразу понятно

```
User: топ 10 дней по объёму в 2024

Understander: ✓ понял
  → "топ 10 дней по объёму в 2024"
```

### 3. Нужна метрика для сравнения

```
User: сравни понедельники и пятницы

Understander: ❌ не понял
  → что сравниваем понятно
  → нужно: по какой метрике

Clarifier: По какой метрике сравнить?
           Например: изменение цены, волатильность, объём?

User: по волатильности

Understander: ✓ понял
  → "сравни волатильность понедельников и пятниц"
```

### 4. Непонятный термин

```
User: покажи фрактальные дни

Understander: ❌ не понял
  → не знаю "фрактальные дни"

Clarifier: Я не знаю что такое "фрактальные дни".
           Можешь объяснить или переформулировать?

User: дни когда high был выше предыдущего

Understander: ✓ понял
  → "покажи дни с higher high"
```

### 5. Defaults работают

```
User: покажи doji

Understander: ✓ понял (period=all, metric=change по умолчанию)
  → "покажи дни с паттерном doji"
```

---

## Разбор реальных вопросов

Вопросы из портрета пользователя — что с ними делает Understander.

### 1. "работает ли торговля на откатах?"

| | |
|---|---|
| **Проблемы** | "откат" не определён, "торговля" какая, "работает" = ? |
| **Цель** | проверить стратегию "покупать откаты" |
| **Clarifier** | "Что имеешь в виду под откатом? Падение на X% после роста?" |

### 2. "стоит ли заходить после пробоя?"

| | |
|---|---|
| **Проблемы** | пробой чего? лонг/шорт? критерий "стоит"? |
| **Цель** | оценить breakout trading |
| **Clarifier** | "Пробой чего — high предыдущего дня? Вход в сторону пробоя?" |

### 3. "понедельники вообще норм?"

| | |
|---|---|
| **Проблемы** | "норм" = ? сравнение с чем? |
| **Цель** | выбрать день для торговли |
| **Clarifier** | "Что важно — волатильность или направление? Сравнить с другими днями?" |

### 4. "а если gap закрылся?"

| | |
|---|---|
| **Проблемы** | неполный вопрос — "то ЧТО?" |
| **Цель** | торговать gap fill |
| **Clarifier** | "Что хочешь узнать — как часто закрывается? Или что после?" |

### 5. "в какое время лучше торговать?"

| | |
|---|---|
| **Проблемы** | "лучше" по какому критерию? "время" = час/период? |
| **Цель** | найти оптимальное время для скальпинга |
| **Clarifier** | "Что для тебя 'лучше' — больше движения или предсказуемее?" |

### 6. "насколько опасны пятницы перед длинными выходными?"

| | |
|---|---|
| **Проблемы** | "опасны" = ? какие выходные? |
| **Цель** | решить торговать или нет перед праздниками |
| **Clarifier** | "Что значит 'опасны' — больше волатильность? Непредсказуемо?" |

### 7. "сетап с doji работает?"

| | |
|---|---|
| **Проблемы** | какой сетап? "работает" = ? |
| **Цель** | проверить паттерн |
| **Clarifier** | "Какой сетап — вход после doji? Или doji как разворот?" |

### 8. "как ведёт себя рынок когда VIX высокий?"

| | |
|---|---|
| **Проблемы** | "высокий" = какой порог? "ведёт себя" = какие метрики? |
| **Цель** | адаптировать торговлю к волатильности |
| **Clarifier** | "Что считаешь высоким — выше 25? 30? Интересует range или направление?" |
| **Граница** | нужны данные VIX — есть ли? |

### 9. "есть смысл держать овернайт?"

| | |
|---|---|
| **Проблемы** | "смысл" по какому критерию? держать что? |
| **Цель** | оценить overnight risk |
| **Clarifier** | "Про риск gap'а утром? Или сколько двигается overnight?" |

### 10. "что обычно после трёх красных дней?"

| | |
|---|---|
| **Проблемы** | "красных" = любые down? или >X%? "что обычно" = ? |
| **Цель** | mean reversion стратегия |
| **Clarifier** | "Три дня вниз — любые или больше X%? Вероятность отскока или размер?" |

---

## Выводы из разбора

**Паттерны уточнений:**

| Мутное слово | Что спрашивать |
|--------------|----------------|
| "работает" | какая метрика успеха? |
| "лучше/норм" | критерий сравнения? |
| "после X" | что показать после? |
| "высокий/большой" | какой порог? |
| неполный вопрос | что именно узнать? |

**Наблюдения:**
- Цель почти всегда можно предположить
- 1-2 уточнения достаточно, не допрос
- Некоторые вопросы за границами системы (VIX, уровни)

---

## Открытые вопросы

1. Где граница между "уточнить" и "применить дефолт"?
2. Как передавать goal в Presenter?
3. Нужен ли словарь "мутных слов" или LLM справится?
