# Multi-Agent Architecture –¥–ª—è AskBar

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**AskBar** ‚Äî —ç—Ç–æ "ChatGPT –¥–ª—è —Ç—Ä–µ–π–¥–µ—Ä–æ–≤". –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ, —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–∞—ë—Ç –æ—Ç–≤–µ—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.

### –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã

–û–¥–∏–Ω –∞–≥–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –≤—Å—ë: –ø–æ–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –ø–∏—à–µ—Ç SQL, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

- **–ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è–º** ‚Äî –∞–≥–µ–Ω—Ç –≤—ã–¥—É–º—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç–∞ 2023-11-10 –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ)
- **–õ–æ–∂–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ** ‚Äî –ø–∏—à–µ—Ç "78%" –∫–æ–≥–¥–∞ –≤ –¥–∞–Ω–Ω—ã—Ö "9.8%"
- **–û—Ç–≤–µ—Ç–∞–º –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö** ‚Äî –Ω–æ–ª—å SQL –∑–∞–ø—Ä–æ—Å–æ–≤, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–∞—è "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
- **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—é –æ—à–∏–±–æ–∫** ‚Äî 3 –∏–∑ 6 –∑–∞–ø—Ä–æ—Å–æ–≤ —É–ø–∞–ª–∏, –∞–≥–µ–Ω—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç

### –†–µ—à–µ–Ω–∏–µ

–†–∞–∑–¥–µ–ª–∏—Ç—å –æ–¥–Ω–æ–≥–æ "—É–º–Ω–æ–≥–æ" –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ "–ø—Ä–æ—Å—Ç—ã—Ö" —Å —á—ë—Ç–∫–∏–º–∏ —Ä–æ–ª—è–º–∏:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "RSI < 30 ‚Äî —Ä—ã–Ω–æ–∫ —Ä–∞—Å—Ç—ë—Ç?"

     ‚îÇ
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Router  ‚îÇ  ‚Üí "–≠—Ç–æ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–∞–Ω–Ω—ã–µ"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Data   ‚îÇ  ‚Üí SELECT ... WHERE rsi < 30 ...
‚îÇ  Agent  ‚îÇ  ‚Üí {rows: [...], count: 47}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Analyst ‚îÇ  ‚Üí "–ò–∑ 47 —Å–ª—É—á–∞–µ–≤ –≤ 43 —Ä—ã–Ω–æ–∫ –≤—ã—Ä–æ—Å..."
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇValidator‚îÇ  ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—Å–µ –¥–∞—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö? ‚úì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚Üì
–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** Data Agent –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã. Analyst –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Ñ–∞–∫—Ç—ã. Validator –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ Analyst –Ω–µ –¥–æ–±–∞–≤–∏–ª –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–∏–ø—ã –∞–≥–µ–Ω—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ **—Ç–∏–ø–∞—Ö –∞–≥–µ–Ω—Ç–æ–≤**, –Ω–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞–≥–µ–Ω—Ç–∞—Ö. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –¢–ò–ü–´ –ê–ì–ï–ù–¢–û–í                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ROUTING        ‚îÇ  DATA               ‚îÇ  OUTPUT                 ‚îÇ
‚îÇ                 ‚îÇ                     ‚îÇ                         ‚îÇ
‚îÇ  –†–µ—à–∞—é—Ç –∫—É–¥–∞    ‚îÇ  –î–æ—Å—Ç–∞—é—Ç/—Å—á–∏—Ç–∞—é—Ç    ‚îÇ  –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç        ‚îÇ
‚îÇ  –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ    ‚îÇ  –¥–∞–Ω–Ω—ã–µ             ‚îÇ  –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é           ‚îÇ
‚îÇ                 ‚îÇ                     ‚îÇ                         ‚îÇ
‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è:     ‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è:         ‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è:             ‚îÇ
‚îÇ  –ù–ï–¢            ‚îÇ  –ö–û–î (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)    ‚îÇ  LLM (–æ–¥–∏–Ω —Ä–∞–∑)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Router       ‚îÇ  ‚Ä¢ SQL Agent        ‚îÇ  ‚Ä¢ Analyst              ‚îÇ
‚îÇ                 ‚îÇ  ‚Ä¢ Indicator Agent  ‚îÇ  ‚Ä¢ Educator             ‚îÇ
‚îÇ                 ‚îÇ  ‚Ä¢ Pattern Agent    ‚îÇ  ‚Ä¢ Risk Analyst         ‚îÇ
‚îÇ                 ‚îÇ  ‚Ä¢ Backtest Agent   ‚îÇ                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ì—Ä–∞—Ñ –∞–≥–µ–Ω—Ç–æ–≤ (LangGraph)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MAIN GRAPH                                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Checkpointer: SQLite (dev) / Postgres (prod)                  ‚îÇ
‚îÇ  Thread ID: user_session_id                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
‚îÇ  ‚îÇ  Router  ‚îÇ (flash)                                          ‚îÇ
‚îÇ  ‚îÇ  ROUTING ‚îÇ                                                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                   ‚îÇ
‚îÇ       ‚îÇ                                                         ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ
‚îÇ       ‚Üì             ‚Üì                 ‚Üì                        ‚îÇ
‚îÇ    [data]      [concept]       [hypothetical]                  ‚îÇ
‚îÇ       ‚îÇ             ‚îÇ                 ‚îÇ                        ‚îÇ
‚îÇ       ‚Üì             ‚Üì                 ‚Üì                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ  Data   ‚îÇ  ‚îÇ Educator ‚îÇ    ‚îÇ  Analyst   ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ  Agent  ‚îÇ  ‚îÇ  OUTPUT  ‚îÇ    ‚îÇ (no data)  ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ  DATA   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  OUTPUT    ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ       ‚îÇ            ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ       ‚Üì            ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ Analyst ‚îÇ       ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  OUTPUT ‚îÇ       ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ       ‚îÇ            ‚îÇ                ‚îÇ                          ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ                    ‚îÇ                                            ‚îÇ
‚îÇ                    ‚Üì                                            ‚îÇ
‚îÇ             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                      ‚îÇ
‚îÇ             ‚îÇ  Validator ‚îÇ                                      ‚îÇ
‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                      ‚îÇ
‚îÇ                   ‚îÇ                                             ‚îÇ
‚îÇ              [status?]                                          ‚îÇ
‚îÇ              /    |    \                                        ‚îÇ
‚îÇ            ok  rewrite  need_data                               ‚îÇ
‚îÇ            ‚Üì     ‚Üì         ‚Üì                                    ‚îÇ
‚îÇ           END  Analyst   Data Agent                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ           interrupt() ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –§–∏—á–∏ LangGraph –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º

### 1. Checkpointer (Persistence)

–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ.

```python
from langgraph.checkpoint.sqlite import SqliteSaver

checkpointer = SqliteSaver.from_conn_string("checkpoints.db")
app = graph.compile(checkpointer=checkpointer)
```

**–ó–∞—á–µ–º:**
- Fault tolerance ‚Äî –µ—Å–ª–∏ —É–ø–∞–ª–æ, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏
- Time Travel ‚Äî –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–ª—è –¥–µ–±–∞–≥–∞
- –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≥—Ä–∞—Ñ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–∞—Å–∞–º–∏

### 2. Thread ID (–°–µ—Å—Å–∏–∏)

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = —Å–≤–æ–π thread. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

```python
config = {"configurable": {"thread_id": f"user_{user_id}"}}
result = app.invoke(state, config)
```

**–ó–∞—á–µ–º:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é

### 3. Interrupt (Human-in-the-Loop)

–ü–∞—É–∑–∞ –≥—Ä–∞—Ñ–∞ –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```python
from langgraph.types import interrupt, Command

def data_agent(state):
    result = execute_sql(state["sql"])

    if len(result["rows"]) < 5:
        # –°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        response = interrupt({
            "message": "–ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ 5 –ø—Ä–∏–º–µ—Ä–æ–≤. –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫?",
            "options": ["–¥–∞", "–Ω–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"]
        })
        if response == "–¥–∞":
            return Command(goto="data_agent", update={"expand_search": True})

    return {"data": result}
```

**–ó–∞—á–µ–º:**
- –ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å–ø—Ä–æ—Å–∏—Ç—å —é–∑–µ—Ä–∞
- –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî —É—Ç–æ—á–Ω–∏—Ç—å
- –û–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

### 4. Parallel Execution

–ù–µ—Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

```python
# –ë—É–¥—É—â–µ–µ: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ Data –∞–≥–µ–Ω—Ç—ã
graph.add_node("parallel_data", {
    "price_data": price_agent,
    "volume_data": volume_agent,
    "indicator_data": indicator_agent
})
```

**–ó–∞—á–µ–º:**
- –ë—ã—Å—Ç—Ä–µ–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 5. Subgraphs (–ò–µ—Ä–∞—Ä—Ö–∏—è)

–ì—Ä—É–ø–ø–∞ –∞–≥–µ–Ω—Ç–æ–≤ –∫–∞–∫ –æ–¥–∏–Ω —É–∑–µ–ª.

```python
# –ë—É–¥—É—â–µ–µ: –∫–æ–º–∞–Ω–¥–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
indicator_team = StateGraph(...)
indicator_team.add_node("rsi", rsi_agent)
indicator_team.add_node("macd", macd_agent)
indicator_subgraph = indicator_team.compile()

main_graph.add_node("indicators", indicator_subgraph)
```

**–ó–∞—á–µ–º:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 6. Commands (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

```python
from langgraph.types import Command

def validator(state):
    if state["validation"]["status"] == "rewrite":
        return Command(
            goto="analyst",
            update={"feedback": state["validation"]["feedback"]}
        )
    return Command(goto="__end__")
```

---

## –°–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –ü—Ä–∏–Ω—Ü–∏–ø: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∞–≥–µ–Ω—Ç–∞

```python
class RoutingAgent:
    """–ê–≥–µ–Ω—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ ‚Äî –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    validation = None

class DataAgent:
    """–ê–≥–µ–Ω—Ç—ã –¥–∞–Ω–Ω—ã—Ö ‚Äî –∫–æ–¥-–≤–∞–ª–∏–¥–∞—Ü–∏—è (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)"""
    def validate(self, output):
        if output.get("error"):
            return {"status": "retry", "reason": output["error"]}
        if not output.get("rows"):
            return {"status": "no_data"}
        if len(output["rows"]) < 5:
            return {"status": "low_sample", "count": len(output["rows"])}
        return {"status": "ok"}

class OutputAgent:
    """–ê–≥–µ–Ω—Ç—ã –≤—ã–≤–æ–¥–∞ ‚Äî LLM-–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—ã—Ö–æ–¥–µ"""
    def validate(self, data, response):
        return validator_llm.check(data, response)
```

### –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏

| –ê–≥–µ–Ω—Ç–æ–≤ | –í–∞–ª–∏–¥–∞—Ü–∏–π | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|---------|-----------|-----------|
| 5 | 1 (–Ω–∞ –≤—ã—Ö–æ–¥–µ) | ~$0.005 |
| 10 | 1 (–Ω–∞ –≤—ã—Ö–æ–¥–µ) | ~$0.005 |
| 20 | 1 (–Ω–∞ –≤—ã—Ö–æ–¥–µ) | ~$0.005 |

**–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ —Ä–∞—Å—Ç—ë—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–≥–µ–Ω—Ç–æ–≤.**

### Validation Loop

```
Data Agent ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                                 ‚îÇ
     ‚Üì                            [need_more_data]
  [–∫–æ–¥-check: ok?]                     ‚îÇ
     ‚îÇ                                 ‚îÇ
     ‚Üì                                 ‚îÇ
  Analyst ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
     ‚îÇ                  ‚îÇ              ‚îÇ
     ‚Üì              [rewrite]          ‚îÇ
 Validator              ‚îÇ              ‚îÇ
     ‚îÇ                  ‚îÇ              ‚îÇ
  [status?]             ‚îÇ              ‚îÇ
   /  |  \              ‚îÇ              ‚îÇ
 ok rewrite need_data   ‚îÇ              ‚îÇ
  ‚Üì    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
 END                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Max attempts: 3 (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞)
```

---

## Streaming: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–∏–Ω—Ü–∏–ø: –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ —á—ë—Ä–Ω–æ–≥–æ —è—â–∏–∫–∞.**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–∞–∂–¥—ã–π —à–∞–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "RSI < 30 —á—Ç–æ –¥–∞–ª—å—à–µ?"                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîÑ Router: –û–ø—Ä–µ–¥–µ–ª—è—é —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞...                     ‚îÇ
‚îÇ  ‚úì –≠—Ç–æ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–∞–Ω–Ω—ã–µ (data)                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîÑ Data Agent: –ü–∏—à—É SQL –∑–∞–ø—Ä–æ—Å...                       ‚îÇ
‚îÇ  ‚úì –í—ã–ø–æ–ª–Ω–µ–Ω –∑–∞–ø—Ä–æ—Å, –Ω–∞–π–¥–µ–Ω–æ 47 –ø—Ä–∏–º–µ—Ä–æ–≤                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîÑ Analyst: –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...                        ‚îÇ
‚îÇ  [—Å—Ç—Ä–∏–º–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏]             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîÑ Validator: –ü—Ä–æ–≤–µ—Ä—è—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã–º...           ‚îÇ
‚îÇ  ‚úì –í—Å–µ –¥–∞—Ç—ã –∏ —á–∏—Å–ª–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### SSE —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

```python
# –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –¥–ª—è streaming
{
    "type": "step_start",
    "agent": "router",
    "message": "–û–ø—Ä–µ–¥–µ–ª—è—é —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞..."
}

{
    "type": "step_end",
    "agent": "router",
    "result": {"route": "data"},
    "duration_ms": 150
}

{
    "type": "step_start",
    "agent": "data_agent",
    "message": "–ü–∏—à—É SQL –∑–∞–ø—Ä–æ—Å..."
}

{
    "type": "sql_executed",
    "query": "SELECT ...",
    "rows_found": 47,
    "duration_ms": 234
}

{
    "type": "text_delta",
    "agent": "analyst",
    "content": "–ò–∑ 47 —Å–ª—É—á–∞–µ–≤..."  # —Å—Ç—Ä–∏–º–∏–Ω–≥ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
}

{
    "type": "validation",
    "status": "ok",
    "issues": []
}

{
    "type": "done",
    "total_duration_ms": 2340,
    "cost_usd": 0.012
}
```

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: —Ö—Ä–∞–Ω–∏–º –í–°–Å

### –¢—Ä–∏ —É—Ä–æ–≤–Ω—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         STORAGE LAYERS                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Checkpointer   ‚îÇ  ‚îÇ    Supabase     ‚îÇ  ‚îÇ  Vector Store   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (LangGraph)    ‚îÇ  ‚îÇ   (Postgres)    ‚îÇ  ‚îÇ   (–±—É–¥—É—â–µ–µ)     ‚îÇ ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Runtime state ‚îÇ  ‚îÇ ‚Ä¢ chat_logs     ‚îÇ  ‚îÇ ‚Ä¢ Embeddings    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Interrupt     ‚îÇ  ‚îÇ ‚Ä¢ request_traces‚îÇ  ‚îÇ ‚Ä¢ Similar Q&A   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Resume        ‚îÇ  ‚îÇ ‚Ä¢ –ü–æ–ª–Ω—ã–π trace  ‚îÇ  ‚îÇ ‚Ä¢ Knowledge base‚îÇ ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞     ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ –ñ–∏–≤—ë—Ç: —Å–µ—Å—Å–∏—è   ‚îÇ  ‚îÇ –ñ–∏–≤—ë—Ç: –Ω–∞–≤—Å–µ–≥–¥–∞ ‚îÇ  ‚îÇ –ñ–∏–≤—ë—Ç: –Ω–∞–≤—Å–µ–≥–¥–∞ ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –†–∞—Å—á—ë—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –ó–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å | –°—Ç—Ä–æ–∫ traces/–≥–æ–¥ | –†–∞–∑–º–µ—Ä/–≥–æ–¥ | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|---------------|---------------|------------------|------------|-----------|
| 100 | 1,000 | 1.8M | 3.6 GB | ~$0.50/–º–µ—Å |
| 1,000 | 10,000 | 18M | 36 GB | ~$4.50/–º–µ—Å |
| 10,000 | 100,000 | 180M | 360 GB | ~$45/–º–µ—Å |

**–í—ã–≤–æ–¥: —Ö—Ä–∞–Ω–∏–º –≤—Å—ë. –°—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–ø–µ–µ—á–Ω–∞—è, –¥–∞–Ω–Ω—ã–µ = –∞–∫—Ç–∏–≤.**

---

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ 1: chat_logs (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)

```sql
CREATE TABLE chat_logs (
    id SERIAL PRIMARY KEY,
    request_id UUID UNIQUE DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    session_id TEXT,                    -- thread_id –∏–∑ LangGraph

    -- –í–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç
    question TEXT,
    response TEXT,

    -- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    route TEXT,                         -- data / concept / hypothetical
    agents_used TEXT[],                 -- ['router', 'data_agent', 'analyst', 'validator']

    -- –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    total_sql_queries INT,
    total_rows_returned INT,
    validation_attempts INT DEFAULT 1,
    validation_passed BOOLEAN,

    -- Human-in-the-loop
    was_interrupted BOOLEAN DEFAULT FALSE,
    interrupt_reason TEXT,

    -- –°—Ç–æ–∏–º–æ—Å—Ç—å (—Å—É–º–º–∞—Ä–Ω–∞—è)
    total_input_tokens INT,
    total_output_tokens INT,
    total_cost_usd DECIMAL(10, 6),

    -- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    total_duration_ms INT,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_chat_logs_user ON chat_logs(user_id);
CREATE INDEX idx_chat_logs_request ON chat_logs(request_id);
CREATE INDEX idx_chat_logs_created ON chat_logs(created_at);
```

### –¢–∞–±–ª–∏—Ü–∞ 2: request_traces (–ø–æ–ª–Ω—ã–π trace –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞)

```sql
CREATE TABLE request_traces (
    id SERIAL PRIMARY KEY,
    request_id UUID REFERENCES chat_logs(request_id),
    user_id UUID REFERENCES auth.users(id),

    -- –®–∞–≥
    step_number INT,
    agent_name TEXT,                    -- 'router', 'data_agent', 'analyst', 'validator'
    agent_type TEXT,                    -- 'routing', 'data', 'output'

    -- –í—Ö–æ–¥/–≤—ã—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞
    input_data JSONB,                   -- —á—Ç–æ –ø–æ–ª—É—á–∏–ª –∞–≥–µ–Ω—Ç
    output_data JSONB,                  -- —á—Ç–æ –≤–µ—Ä–Ω—É–ª

    -- SQL (–¥–ª—è Data –∞–≥–µ–Ω—Ç–æ–≤)
    sql_query TEXT,
    sql_result JSONB,
    sql_rows_returned INT,
    sql_error TEXT,

    -- –í–∞–ª–∏–¥–∞—Ü–∏—è (–¥–ª—è Validator)
    validation_status TEXT,             -- 'ok', 'rewrite', 'need_more_data'
    validation_issues TEXT[],
    validation_feedback TEXT,

    -- LLM –¥–µ—Ç–∞–ª–∏
    prompt_template TEXT,               -- –∫–∞–∫–æ–π –ø—Ä–æ–º–ø—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏
    model_used TEXT,
    input_tokens INT,
    output_tokens INT,
    thinking_tokens INT,
    cost_usd DECIMAL(10, 6),

    -- –¢–∞–π–º–∏–Ω–≥
    started_at TIMESTAMPTZ,
    finished_at TIMESTAMPTZ,
    duration_ms INT,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_traces_request ON request_traces(request_id);
CREATE INDEX idx_traces_user ON request_traces(user_id);
CREATE INDEX idx_traces_agent ON request_traces(agent_name);
CREATE INDEX idx_traces_created ON request_traces(created_at);
CREATE INDEX idx_traces_validation ON request_traces(validation_status) WHERE validation_status IS NOT NULL;
```

### –ß—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ –∫–∞–∂–¥–æ–º trace

| –ê–≥–µ–Ω—Ç | –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º |
|-------|---------------|
| Router | input: question, output: route, duration |
| Data Agent | input: question, sql_query, sql_result, rows, errors, duration |
| Analyst | input: data, output: response (full text), tokens, duration |
| Validator | input: data+response, validation_status, issues, feedback, duration |

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –∞–≥–µ–Ω—Ç–∞

```python
async def log_trace_step(
    request_id: str,
    user_id: str,
    step_number: int,
    agent_name: str,
    agent_type: str,
    input_data: dict,
    output_data: dict,
    duration_ms: int,
    **kwargs  # sql_query, validation_status, etc.
):
    await supabase.table("request_traces").insert({
        "request_id": request_id,
        "user_id": user_id,
        "step_number": step_number,
        "agent_name": agent_name,
        "agent_type": agent_type,
        "input_data": input_data,
        "output_data": output_data,
        "duration_ms": duration_ms,
        "started_at": kwargs.get("started_at"),
        "finished_at": kwargs.get("finished_at"),
        "sql_query": kwargs.get("sql_query"),
        "sql_result": kwargs.get("sql_result"),
        "sql_rows_returned": kwargs.get("sql_rows_returned"),
        "sql_error": kwargs.get("sql_error"),
        "validation_status": kwargs.get("validation_status"),
        "validation_issues": kwargs.get("validation_issues"),
        "validation_feedback": kwargs.get("validation_feedback"),
        "prompt_template": kwargs.get("prompt_template"),
        "model_used": kwargs.get("model_used"),
        "input_tokens": kwargs.get("input_tokens"),
        "output_tokens": kwargs.get("output_tokens"),
        "thinking_tokens": kwargs.get("thinking_tokens"),
        "cost_usd": kwargs.get("cost_usd"),
    }).execute()
```

### –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

```python
async def log_completion(request_id: str, user_id: str, state: dict):
    await supabase.table("chat_logs").insert({
        "request_id": request_id,
        "user_id": user_id,
        "session_id": state["thread_id"],
        "question": state["question"],
        "response": state["response"],
        "route": state["route"],
        "agents_used": state["agents_used"],
        "total_sql_queries": len(state.get("sql_queries", [])),
        "total_rows_returned": state.get("total_rows", 0),
        "validation_attempts": state.get("attempts", 1),
        "validation_passed": state.get("validation", {}).get("status") == "ok",
        "was_interrupted": state.get("was_interrupted", False),
        "interrupt_reason": state.get("interrupt_reason"),
        "total_input_tokens": state["usage"]["total_input"],
        "total_output_tokens": state["usage"]["total_output"],
        "total_cost_usd": state["usage"]["total_cost"],
        "total_duration_ms": state["total_duration_ms"],
    }).execute()
```

---

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: —á—Ç–æ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å

### –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```sql
-- –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç–æ–≤
SELECT route, COUNT(*) as count
FROM chat_logs
GROUP BY route;

-- –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ —Ç–∏–ø—É –≤–æ–ø—Ä–æ—Å–∞
SELECT route, AVG(total_cost_usd) as avg_cost
FROM chat_logs
GROUP BY route;

-- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ Validator –≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
SELECT validation_attempts, COUNT(*)
FROM chat_logs
WHERE validation_attempts > 1
GROUP BY validation_attempts;
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

```sql
-- –ö–∞–∫–∏–µ SQL –∑–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç
SELECT sql_query, sql_error, COUNT(*)
FROM request_traces
WHERE sql_error IS NOT NULL
GROUP BY sql_query, sql_error
ORDER BY COUNT(*) DESC;

-- –ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞—Ö–æ–¥–∏—Ç Validator
SELECT unnest(validation_issues) as issue, COUNT(*)
FROM request_traces
WHERE validation_issues IS NOT NULL
GROUP BY issue
ORDER BY COUNT(*) DESC;

-- –°–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã
SELECT agent_name, AVG(duration_ms), MAX(duration_ms)
FROM request_traces
GROUP BY agent_name;
```

### –î–ª—è –±—É–¥—É—â–µ–≥–æ ML/Vector

```sql
-- –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è: —É—Å–ø–µ—à–Ω—ã–µ –ø–∞—Ä—ã –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç
SELECT
    cl.question,
    cl.response,
    cl.route,
    rt.sql_query
FROM chat_logs cl
JOIN request_traces rt ON cl.request_id = rt.request_id
WHERE cl.validation_passed = true
AND rt.agent_name = 'data_agent';

-- –î–∞–Ω–Ω—ã–µ –¥–ª—è vector search: –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
SELECT DISTINCT question, response, route
FROM chat_logs
WHERE validation_passed = true;
```

---

## –ü—Ä–æ–º–ø—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤

### Router (ROUTING)
```
–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- "data" ‚Äî –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –±—ç–∫—Ç–µ—Å—Ç)
- "concept" ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ (—á—Ç–æ —Ç–∞–∫–æ–µ RSI, MACD)
- "hypothetical" ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–π "—á—Ç–æ –µ—Å–ª–∏", –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º.
```

### Data Agent (DATA)
```
–¢—ã SQL-–∞–≥–µ–Ω—Ç –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã ohlcv_1min.

–°—Ö–µ–º–∞: symbol, timestamp, open, high, low, close, volume

–ó–∞–¥–∞—á–∞:
1. –ù–∞–ø–∏—à–∏ SQL –∑–∞–ø—Ä–æ—Å
2. –í—ã–ø–æ–ª–Ω–∏ –µ–≥–æ
3. –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ JSON

–ó–ê–ü–†–ï–©–ï–ù–û: –¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å, –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.
–¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ.
```

### Analyst (OUTPUT)
```
–í–æ—Ç –¥–∞–Ω–Ω—ã–µ: {data}

–°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

–ó–ê–ü–†–ï–©–ï–ù–û:
- –î–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
- –í—ã–¥—É–º—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–ª–∏ —á–∏—Å–ª–∞
- –ü–∏—Å–∞—Ç—å "–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏" –±–µ–∑ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º —è–≤–Ω–æ.
```

### Educator (OUTPUT)
```
–û–±—ä—è—Å–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é "{concept}" –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.

–ó–ê–ü–†–ï–©–ï–ù–û:
- –ù–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –°—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã—Ö —É —Ç–µ–±—è –Ω–µ—Ç

–¢–æ–ª—å–∫–æ —Ç–µ–æ—Ä–∏—è –∏ –æ–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã.
```

### Validator
```
–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã–º.

–î–∞–Ω–Ω—ã–µ (JSON): {data}
–û—Ç–≤–µ—Ç: {response}

–ü—Ä–æ–≤–µ—Ä—å:
1. –í—Å–µ –¥–∞—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –¥–∞–Ω–Ω—ã—Ö?
2. –í—Å–µ —á–∏—Å–ª–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤–∑—è—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö?
3. –ù–µ—Ç –ª–∏ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤?
4. –í—ã–≤–æ–¥—ã –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–ª–µ–¥—É—é—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö?

–û—Ç–≤–µ—Ç—å JSON:
{
  "status": "ok" | "rewrite" | "need_more_data",
  "issues": ["—Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å"],
  "feedback": "—á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å"
}
```

---

## –ú–æ–¥–µ–ª–∏ –ø–æ –∞–≥–µ–Ω—Ç–∞–º

| –ê–≥–µ–Ω—Ç | –¢–∏–ø | –ú–æ–¥–µ–ª—å | –¶–µ–Ω–∞ –∑–∞ –∑–∞–ø—Ä–æ—Å |
|-------|-----|--------|----------------|
| Router | ROUTING | Gemini Flash | ~$0.0001 |
| Data Agent | DATA | Gemini Flash | ~$0.001 |
| Analyst | OUTPUT | Sonnet / Pro | ~$0.01 |
| Educator | OUTPUT | Sonnet / Pro | ~$0.01 |
| Validator | ‚Äî | Sonnet / Pro | ~$0.005 |

---

## –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
agent/
‚îú‚îÄ‚îÄ graph.py              # LangGraph –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ state.py              # State TypedDict
‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îú‚îÄ‚îÄ routing.py        # BaseRoutingAgent
‚îÇ   ‚îú‚îÄ‚îÄ data.py           # BaseDataAgent + –∫–æ–¥-–≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ output.py         # BaseOutputAgent + LLM-–≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îú‚îÄ‚îÄ router.py         # Router
‚îÇ   ‚îú‚îÄ‚îÄ data_agent.py     # Data Agent
‚îÇ   ‚îú‚îÄ‚îÄ analyst.py        # Analyst
‚îÇ   ‚îú‚îÄ‚îÄ educator.py       # Educator
‚îÇ   ‚îî‚îÄ‚îÄ validator.py      # Validator
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îú‚îÄ‚îÄ queries.py        # SQL —à–∞–±–ª–æ–Ω—ã
‚îÇ   ‚îî‚îÄ‚îÄ executor.py       # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îî‚îÄ‚îÄ templates.py      # –ü—Ä–æ–º–ø—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤
‚îî‚îÄ‚îÄ logging/
    ‚îî‚îÄ‚îÄ supabase.py       # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Supabase
```

---

## –ó–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞

### –§–∞–∑–∞ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –æ–±–Ω–æ–≤–∏—Ç—å `chat_logs` (–Ω–æ–≤—ã–µ –ø–æ–ª—è)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —Å–æ–∑–¥–∞—Ç—å `request_traces`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

### –§–∞–∑–∞ 2: LangGraph —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] `pip install langgraph`
- [ ] –°–æ–∑–¥–∞—Ç—å `state.py` —Å TypedDict
- [ ] –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –∞–≥–µ–Ω—Ç–æ–≤ (`base/`)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Checkpointer (SQLite –¥–ª—è dev)

### –§–∞–∑–∞ 3: –ê–≥–µ–Ω—Ç—ã
- [ ] Router
- [ ] Data Agent + –∫–æ–¥-–≤–∞–ª–∏–¥–∞—Ü–∏—è
- [ ] Analyst
- [ ] Educator
- [ ] Validator

### –§–∞–∑–∞ 4: –ì—Ä–∞—Ñ
- [ ] –°–æ–±—Ä–∞—Ç—å –≥—Ä–∞—Ñ –≤ `graph.py`
- [ ] Conditional edges (—Ä–æ—É—Ç–∏–Ω–≥)
- [ ] Validation loop —Å Command
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å api.py

### –§–∞–∑–∞ 5: Streaming + –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] SSE —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- [ ] `log_trace_step()` ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
- [ ] `log_completion()` ‚Äî –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- [ ] –§—Ä–æ–Ω—Ç–µ–Ω–¥: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–≥–æ–≤

### –§–∞–∑–∞ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] "RSI < 30 —á—Ç–æ –¥–∞–ª—å—à–µ?" ‚Üí —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] "–ß—Ç–æ —Ç–∞–∫–æ–µ MACD?" ‚Üí –±–µ–∑ —Ü–∏—Ñ—Ä
- [ ] "–ß—Ç–æ –µ—Å–ª–∏ volume 75%?" ‚Üí "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Validator –ª–æ–≤–∏—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ traces –ø–∏—à—É—Ç—Å—è –≤ –±–∞–∑—É

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤
- [ ] –ù–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π (–ø—Ä–∏–º–µ—Ä—ã —Ç–æ–ª—å–∫–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö)
- [ ] SQL –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —è–≤–Ω–æ
- [ ] Hypothetical –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –≤—ã–¥–∞—é—Ç —Ñ–µ–π–∫–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- [ ] Validator –ª–æ–≤–∏—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–≤–µ—Ç–∞

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] Checkpointer —Ä–∞–±–æ—Ç–∞–µ—Ç (fault tolerance)
- [ ] Thread ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏
- [ ] Interrupt/resume —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è human-in-the-loop

### UX
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–∞–∂–¥—ã–π —à–∞–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- [ ] Streaming —Ç–µ–∫—Å—Ç–∞ –æ—Ç Analyst —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

### –î–∞–Ω–Ω—ã–µ
- [ ] chat_logs: –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å –∏—Ç–æ–≥–∞–º–∏
- [ ] request_traces: –∫–∞–∂–¥—ã–π —à–∞–≥ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
- [ ] –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- [ ] –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ –≤—ã—Ä–æ—Å–ª–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ (< 2x)
- [ ] Latency –ø—Ä–∏–µ–º–ª–µ–º–∞—è (< 10 —Å–µ–∫ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤)

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–±—É–¥—É—â–µ–µ)

### –ù–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã

```python
# –ü—Ä–æ—Å—Ç–æ –Ω–∞—Å–ª–µ–¥—É–µ–º –æ—Ç –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞
class IndicatorAgent(DataAgent):
    """–†–∞—Å—á—ë—Ç RSI, MACD, Bollinger"""
    pass

class PatternAgent(DataAgent):
    """–ü–æ–∏—Å–∫ —Å–≤–µ—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"""
    pass

class BacktestAgent(DataAgent):
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π"""
    pass

class RiskAnalyst(OutputAgent):
    """–ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤"""
    pass
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```python
graph.add_node("parallel_analysis", {
    "indicators": indicator_agent,
    "patterns": pattern_agent,
    "levels": levels_agent
})
```

### Subgraphs

```python
# –ö–æ–º–∞–Ω–¥–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
ta_team = StateGraph(...)
ta_team.add_node("rsi", rsi_agent)
ta_team.add_node("macd", macd_agent)
ta_subgraph = ta_team.compile()

main_graph.add_node("technical_analysis", ta_subgraph)
```

---

## –°—Å—ã–ª–∫–∏

- [LangGraph Official](https://www.langchain.com/langgraph)
- [Multi-Agent Workflows](https://blog.langchain.com/langgraph-multi-agent-workflows/)
- [Interrupts Documentation](https://docs.langchain.com/oss/python/langgraph/interrupts)
- [Human-in-the-Loop](https://blog.langchain.com/making-it-easier-to-build-human-in-the-loop-agents-with-interrupt/)
