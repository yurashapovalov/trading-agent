# Architecture Overview

## Главный принцип

**Code for Facts, LLM for Text**

```
Код считает цифры → LLM пишет текст
```

- Код вычисляет всё детерминированно: статистику, паттерны, события
- LLM только превращает готовые факты в человеческий текст
- LLM никогда не видит сырые данные — не может галлюцинировать цифры

## Поток данных

```
Пользователь          Агенты                    Данные
     │                   │                        │
     │  "волатильность"  │                        │
     ├──────────────────►│                        │
     │                   │                        │
     │              ┌────┴────┐                   │
     │              │ Intent  │ data/chitchat?    │
     │              └────┬────┘                   │
     │                   │                        │
     │              ┌────┴────┐                   │
     │              │ Parser  │ NL → steps        │
     │              └────┬────┘                   │
     │                   │                        │
     │              ┌────┴────┐                   │
     │              │ Planner │ steps → plan      │
     │              └────┬────┘                   │
     │                   │                        │
     │              ┌────┴────┐                   │
     │              │Executor │◄──────────────────┤ DuckDB
     │              └────┬────┘                   │
     │                   │ {rows, summary}        │
     │◄──────────────────┤                        │
     │                   │                        │
```

## Ключевые компоненты

| Компонент | Задача |
|-----------|--------|
| **Intent** | Классифицирует намерение (data/chitchat/concept) |
| **Parser** | NL → структурированный запрос (steps, atoms) |
| **Planner** | Строит план выполнения (DataRequests) |
| **Executor** | Выполняет запрос к DuckDB |
| **Rules** | Валидация + auto-fix ошибок LLM |
| **RAP** | Выбор релевантных chunks для промпта |

## Документация

- [Агенты](agents.md) — Intent, Parser, Planner, Executor
- [Граф](graph.md) — LangGraph, роутинг, state
- [Память](memory.md) — кэширование и история разговора
- [Данные](data-layer.md) — Executor, 9 операций
- [Конфиги](config.md) — паттерны, события, праздники
- [Правила](rules.md) — валидация и auto-fix ошибок LLM
- [RAP](rap.md) — Retrieval-Augmented Prompting
