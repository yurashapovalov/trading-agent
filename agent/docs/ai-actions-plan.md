# AI Actions & Pinned Sidebar — План реализации

## Цель

Добавить возможность пользователям оценивать ответы (like/dislike) и сохранять лучшие (pin) для быстрого доступа в сайдбаре.

---

## Структура UI

```
┌────────────┬─────────────────────────┬──────────────┐
│   Чаты     │                         │   📌 Pins    │
│  (потом)   │         Chat            │              │
│            │                         │  [карточки]  │
│            │                         │              │
└────────────┴─────────────────────────┴──────────────┘
    слева           центр                  справа
```

---

## Изменения в БД

### Таблица: chat_logs

```sql
ALTER TABLE chat_logs ADD COLUMN pinned BOOLEAN DEFAULT FALSE;
ALTER TABLE chat_logs ADD COLUMN feedback JSONB;
```

### Структура feedback

```json
{
  "rating": "like" | "dislike",
  "description": "опциональный текст"
}
```

**Примеры:**
```json
{"rating": "like", "description": ""}
{"rating": "dislike", "description": "Неправильно посчитал корреляцию"}
{"rating": "dislike", "description": ""}
```

---

## API Endpoints

### 1. PATCH /chat/{id}/feedback

Обновление feedback и/или pinned для сообщения.

**Request:**
```json
{
  "pinned": true,
  "feedback": {
    "rating": "like",
    "description": ""
  }
}
```

**Response:**
```json
{
  "id": 91,
  "pinned": true,
  "feedback": {"rating": "like", "description": ""}
}
```

### 2. GET /chat/pinned

Получение списка запиненных сообщений пользователя.

**Response:**
```json
[
  {
    "id": 91,
    "question": "Посчитай корреляцию...",
    "response": "На основе анализа...",
    "created_at": "2026-01-13T08:34:42Z"
  }
]
```

---

## Frontend компоненты

### 1. AIActions

Кнопки под каждым ответом модели.

```
┌─────────────────────────────────────────┐
│ Ответ модели...                         │
└─────────────────────────────────────────┘
     👍  👎  📌
```

**Состояния:**
- Default: серые иконки
- Liked: 👍 зелёная
- Disliked: 👎 красная
- Pinned: 📌 жёлтая/золотая

**Поведение:**
- Клик на 👍 — сразу отправляет like
- Клик на 👎 — открывает модалку с полем description
- Клик на 📌 — toggle pin состояния

### 2. DislikeFeedbackModal

Модалка для объяснения dislike.

```
┌─────────────────────────────────────┐
│  Что не так с ответом?              │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ Опишите проблему (опционально)│  │
│  │                               │  │
│  └───────────────────────────────┘  │
│                                     │
│         [Отмена]  [Отправить]       │
└─────────────────────────────────────┘
```

### 3. PinnedSidebar

Сайдбар справа со списком запиненных сообщений.

```
┌──────────────────┐
│  📌 Закладки     │
│                  │
│ ┌──────────────┐ │
│ │ Корреляция   │ │
│ │ объёма и...  │ │
│ │ 13 янв 2026  │ │
│ └──────────────┘ │
│                  │
│ ┌──────────────┐ │
│ │ Лучшие точки │ │
│ │ входа для... │ │
│ │ 12 янв 2026  │ │
│ └──────────────┘ │
│                  │
└──────────────────┘
```

**Карточка содержит:**
- Начало вопроса (обрезанное)
- Дата
- Клик — скролл к сообщению в чате

---

## Удалить

- Счётчик токенов из UI (данные остаются в БД для аналитики)

---

## Порядок реализации

### Этап 1: Backend
- [ ] Миграция БД (pinned, feedback)
- [ ] API: PATCH /chat/{id}/feedback
- [ ] API: GET /chat/pinned

### Этап 2: Frontend — AIActions
- [ ] Компонент AIActions
- [ ] Модалка DislikeFeedbackModal
- [ ] Интеграция с чатом
- [ ] Убрать счётчик токенов

### Этап 3: Frontend — Sidebar
- [ ] Компонент PinnedSidebar
- [ ] Карточки с превью
- [ ] Скролл к сообщению по клику

### Этап 4: Тестирование
- [ ] Like/dislike сохраняется
- [ ] Pin toggle работает
- [ ] Сайдбар обновляется
- [ ] Скролл к сообщению работает

---

## Будущие улучшения

- Использовать pinned сообщения для few-shot примеров
- Аналитика по feedback (какие ответы нравятся/не нравятся)
- Фильтры в сайдбаре (по дате, по теме)
